<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TempMailsPro — Disposable Email</title>
  <meta name="description" content="Generate disposable temporary emails instantly. No signup. Extend timer and recover using token." />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <h1>TempMailsPro</h1>
    <p>Generate disposable email addresses for testing and privacy. No signup required.</p>

    <section id="controls" class="card">
      <div class="row">
        <button id="gen-mail">Generate Random Email</button>
        <input id="manual-login" placeholder="custom login (optional)" />
        <select id="domain-select"></select>
        <button id="use-manual">Use Email</button>
      </div>
      <div class="row">
        <button id="extend-mail" style="display:none">Add 10 minutes</button>
        <button id="copy-email" style="display:none">Copy Email</button>
      </div>
      <p>Current inbox: <strong id="current-inbox">—</strong></p>
      <p id="countdown" style="font-weight:bold"></p>
      <p>Recovery Link (save this): <a id="recovery-link" href="#">—</a></p>
    </section>

    <section id="inbox" class="card">
      <h2>Inbox</h2>
      <button id="refresh-mails">Refresh Inbox</button>
      <ul id="messages-list"></ul>
      <div id="message-view"></div>
    </section>

    <section class="card">
      <h3>How it works</h3>
      <p>This site uses a backend proxy to communicate with public temporary email providers and stores a short-lived mailbox token for recovery and extension. Do not use for sensitive personal communication.</p>
    </section>
  </main>

<script>
const domains = ["1secmail.com","1secmail.org","1secmail.net","wwjmp.com","esiix.com","xojxe.com"];
const domainSelect = document.getElementById('domain-select');
domainSelect.innerHTML = domains.map(d=>`<option>${d}</option>`).join('');
let current = null;
let countdownTimer = null;

function saveLocal(mb){
  if(!mb) return;
  localStorage.setItem('tempmb', JSON.stringify(mb));
}

function loadLocal(){
  const s = localStorage.getItem('tempmb');
  if(!s) return null;
  try { return JSON.parse(s); } catch(e){return null;}
}

function showInboxInfo(mb){
  if(!mb) return;
  document.getElementById('current-inbox').innerText = mb.login + '@' + mb.domain;
  document.getElementById('recovery-link').innerText = location.origin + '/?recover=' + mb.token;
  document.getElementById('recovery-link').href = location.origin + '/?recover=' + mb.token;
  document.getElementById('extend-mail').style.display = 'inline-block';
  document.getElementById('copy-email').style.display = 'inline-block';
  startCountdown(mb.expiresAt);
}

function startCountdown(expiresAt){
  clearInterval(countdownTimer);
  function update(){
    const ms = expiresAt - Date.now();
    if(ms<=0){
      document.getElementById('countdown').innerText = 'Expired';
      clearInterval(countdownTimer);
      return;
    }
    const mins = Math.floor(ms/60000);
    const secs = Math.floor((ms%60000)/1000);
    document.getElementById('countdown').innerText = `Expires in ${mins}m ${secs}s`;
  }
  update();
  countdownTimer = setInterval(update, 1000);
}

async function genMailbox(login, domain){
  const params = new URLSearchParams();
  if(login) params.set('login', login);
  if(domain) params.set('domain', domain);
  const resp = await fetch('/api/genMailbox?' + params.toString());
  const data = await resp.json();
  current = data;
  saveLocal(current);
  showInboxInfo(current);
  fetchMessages();
}

document.getElementById('gen-mail').addEventListener('click', ()=>genMailbox());
document.getElementById('use-manual').addEventListener('click', ()=>{
  const login = document.getElementById('manual-login').value.trim();
  const domain = domainSelect.value;
  if(!login){ alert('Enter login or use Generate'); return; }
  genMailbox(login, domain);
});
document.getElementById('refresh-mails').addEventListener('click', fetchMessages);
document.getElementById('extend-mail').addEventListener('click', async ()=>{
  if(!current){ alert('No inbox'); return; }
  const resp = await fetch('/api/extendMailbox', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ login: current.login, domain: current.domain, token: current.token, extraMinutes: 10 })
  });
  const data = await resp.json();
  if(data.ok){ current.expiresAt = data.expiresAt; saveLocal(current); startCountdown(current.expiresAt); alert('Extended by 10 minutes'); }
  else alert('Extend failed: ' + JSON.stringify(data));
});
document.getElementById('copy-email').addEventListener('click', ()=>{
  if(!current) return;
  const txt = current.login + '@' + current.domain;
  navigator.clipboard.writeText(txt).then(()=> alert('Copied'));
});

async function fetchMessages(){
  if(!current){ alert('No inbox'); return; }
  const resp = await fetch(`/api/getMessages?login=${encodeURIComponent(current.login)}&domain=${encodeURIComponent(current.domain)}`);
  const msgs = await resp.json();
  const list = document.getElementById('messages-list');
  list.innerHTML = '';
  if(Array.isArray(msgs) && msgs.length>0){
    msgs.forEach(m=>{
      const li = document.createElement('li');
      li.innerHTML = `<a href="#" data-id="${m.id}" class="msg-link">${m.from} — ${m.subject} <small>(${m.date})</small></a>`;
      list.appendChild(li);
    });
    document.querySelectorAll('.msg-link').forEach(el=>{
      el.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const id = ev.target.dataset.id;
        const r = await fetch(`/api/readMessage?login=${encodeURIComponent(current.login)}&domain=${encodeURIComponent(current.domain)}&id=${id}`);
        const msg = await r.json();
        const view = document.getElementById('message-view');
        view.innerHTML = `<h3>${msg.subject}</h3><p>From: ${msg.from} — ${msg.date}</p><div>${msg.htmlBody || ('<pre>'+msg.body+'</pre>')}</div>`;
      });
    });
  } else {
    list.innerHTML = '<li>No messages</li>';
  }
}

// on load: try recover from query ?recover=token or localStorage
window.addEventListener('load', async ()=>{
  const url = new URL(location.href);
  const rt = url.searchParams.get('recover');
  if(rt){
    const resp = await fetch('/api/recover?token=' + encodeURIComponent(rt));
    if(resp.ok){
      const mb = await resp.json();
      current = mb;
      saveLocal(current);
      showInboxInfo(current);
      fetchMessages();
      return;
    }
  }
  const local = loadLocal();
  if(local){
    // check if still in store (recover)
    const resp = await fetch('/api/recover?token=' + encodeURIComponent(local.token));
    if(resp.ok){
      const mb = await resp.json();
      current = mb;
      saveLocal(current);
      showInboxInfo(current);
      fetchMessages();
      return;
    } else {
      // fallback: create new mailbox with same login/domain
      current = null;
    }
  }
});
</script>
</body>
</html>
